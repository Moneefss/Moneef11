<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>نظام إدارة القضايا</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
  --dark-blue: #0c2d48;
  --medium-blue: #145da0;
  --light-blue: #2d8cba;
  --lightest-blue: #b1d4e0;
  --white: #fff;
  --gray: #f4f8fe;
  --border: #d8e4f7;
  --shadow: #3b8beb33;
}
body {
  min-height: 100vh;
  background: linear-gradient(135deg, var(--dark-blue) 60%, var(--light-blue) 100%);
  font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
  margin: 0;
  color: var(--dark-blue);
}
#container {
  width: 100%;
  max-width: 480px;
  margin: 0 auto;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  padding-bottom: 24px;
}
.card {
  background: rgba(255, 255, 255, 0.13);
  backdrop-filter: blur(6px);
  border-radius: 15px;
  box-shadow: 0 4px 32px var(--shadow), 0 0px 0px #0000;
  padding: 22px 4vw 16px 4vw;
  margin: 12px auto;
  width: 98vw;
  max-width: 425px;
  border: 1.2px solid var(--lightest-blue);
  transition: box-shadow .3s;
}
.card h2 {
  margin-top: 0;
  background: linear-gradient(90deg, var(--medium-blue), var(--light-blue));
  color: var(--white);
  border-radius: 7px;
  padding: 8px 0 7px 0;
  margin-bottom: 14px;
  box-shadow: 0 2px 8px var(--shadow);
  font-size: 1.27em;
  text-align: center;
  letter-spacing: 1px;
}
label {
  display: block;
  margin-top: 16px;
  color: var(--white);
  font-weight: bold;
  font-size: 1em;
  letter-spacing: 0.5px;
  text-shadow: 0 1px 2px #0008;
}
input, select, textarea, button {
  width: 100%;
  padding: 10px;
  margin-top: 7px;
  border-radius: 8px;
  border: 1.2px solid var(--lightest-blue);
  font-size: 1em;
  outline: none;
  transition: border .2s, background .2s;
  box-sizing: border-box;
  background: var(--gray);
  color: var(--dark-blue);
}
input:focus, select:focus, textarea:focus {
  border-color: var(--medium-blue);
  background: #e2edfd;
  color: var(--medium-blue);
}
input[readonly], textarea[readonly] {
  background: #f6fafd !important;
  color: #757575;
  font-weight: 500;
}
input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
input[type="number"] {
  appearance: textfield;
}
button {
  background: linear-gradient(90deg, var(--medium-blue), var(--light-blue) 80%);
  color: var(--white);
  font-weight: bold;
  border: none;
  margin-top: 16px;
  cursor: pointer;
  letter-spacing: 1px;
  transition: background .2s, box-shadow .2s;
  box-shadow: 0 2px 8px var(--shadow);
  font-size: 1em;
}
button:hover { background: linear-gradient(90deg, var(--light-blue), var(--medium-blue)); }
.menu-btn {
  width: 100%;
  margin: 10px 0;
  padding: 14px;
  background: linear-gradient(90deg, var(--medium-blue), var(--light-blue));
  color: var(--white);
  border: none;
  border-radius: 10px;
  font-size: 1.05em;
  font-weight: bold;
  box-shadow: 0 2px 8px var(--shadow);
  cursor: pointer;
  transition: background 0.2s;
  border: 2px solid var(--lightest-blue);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
}
.menu-btn i { font-size: 1em; }
.menu-btn:hover { background: linear-gradient(90deg, var(--light-blue), var(--medium-blue)); }
.menu-list { margin-top: 16px; }
.note {
  color: var(--medium-blue);
  font-size: 0.92em;
  margin: 11px 0 0 0;
  text-align: center;
  opacity: 0.87;
}
.settings-list {
  margin: 0 0 14px 0;
  padding: 0;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.settings-btn {
  background: linear-gradient(90deg, var(--dark-blue), var(--light-blue));
  color: var(--white);
  font-size: 0.98em;
  border: none;
  border-radius: 9px;
  padding: 10px 0;
  cursor: pointer;
  transition: background 0.2s;
  box-shadow: 0 2px 8px var(--shadow);
  display: flex;
  align-items: center;
  gap: 9px;
  justify-content: center;
}
.settings-btn i { font-size: 1.05em; }
.settings-btn:hover { background: linear-gradient(90deg, var(--light-blue), var(--medium-blue)); }
@media (max-width:600px) {
  #container { max-width: 100vw; }
  .card { padding: 4px 2vw 4px 2vw; max-width: 100vw;}
  label, input, select, textarea, button { font-size: 1em; }
  .menu-btn, .settings-btn { font-size: .98em; padding: 10px 0;}
}
.alert {
  background: #e8f0fa;
  color: var(--dark-blue);
  border: 1.7px solid var(--light-blue);
  padding: 9px 0;
  margin: 0 0 12px 0;
  border-radius: 8px;
  text-align: center;
  font-size: 0.98em;
  font-weight: 600;
  box-shadow: 0 2px 8px var(--shadow);
}
.table-wrap {
  overflow-x: auto;
  margin-top: 12px;
}
table {
  width: 100%;
  border-collapse: collapse;
  background: linear-gradient(120deg, #f9fbfe 60%, #e8f2fc 140%);
  border-radius: 8px;
  overflow: hidden;
  margin-bottom: 7px;
}
th, td {
  border: 1.2px solid var(--light-blue);
  padding: 8px 2px;
  text-align: center;
  font-size: 0.97em;
}
th {
  background: linear-gradient(90deg, var(--light-blue), #e5f1fd 75%);
  color: var(--dark-blue);
  font-weight: bold;
}
tr.selected, tr:hover {
  background: #c2e0ff;
}
input[type="checkbox"] {
  width: 17px;
  height: 17px;
  accent-color: var(--light-blue);
  margin-top: 0;
}
::-webkit-input-placeholder { color: #7ab7e6; }
::-moz-placeholder { color: #7ab7e6; }
:-ms-input-placeholder { color: #7ab7e6; }
::placeholder { color: #7ab7e6; }
a.future-link {
  color: var(--light-blue);
  text-decoration: underline;
  cursor: pointer;
  font-weight: bold;
  display: inline-block;
  margin: 10px 0 0 0;
  font-size: 1em;
}
a.future-link:hover {
  color: var(--dark-blue);
  text-decoration: underline wavy;
}
.settings-section { margin-top: 10px; }
.excel-btn {
  background: linear-gradient(90deg, #1d7fbb, #6be4ff);
  color: #fff;
  border-radius: 7px;
  margin-top: 5px;
  margin-bottom: 7px;
  font-size: 1em;
  font-weight: bold;
  transition: background 0.15s;
  border: none;
  box-shadow: 0 1px 6px #2d8cba44;
}
.excel-btn i { margin-left: 7px; }
.excel-btn:hover { background: linear-gradient(90deg, #6be4ff, #1d7fbb);}
.sys-info-row {
  background: #1a3457;
  color: #fff;
  border-radius: 8px;
  margin-top: 7px;
  padding: 7px 8px 6px 8px;
  font-weight: bold;
  font-size: .95em;
  letter-spacing: .5px;
  text-align: left;
  direction: ltr;
  user-select: text;
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 7px;
  justify-content: flex-start;
}
.sys-info-row span {
  margin-left: 7px;
}
#activityHistoryList {
  margin-top: 7px; background: #0c223b; border-radius: 8px; padding: 8px; color: #fff;
  font-size: 0.93em;
  max-height: 140px; overflow-y: auto;
}
#activityHistoryList li { padding:3px 0 3px 0; border-bottom: 1px dashed #b1d4e0; font-family: Tahoma,Arial; }
#activityHistoryList li:last-child { border-bottom: none; }
.disabled {
  pointer-events: none;
  opacity: 0.7;
  filter: grayscale(1);
}
</style>
</head>
<body>
<div id="container">
  <div id="alert" class="alert" style="display:none"></div>

  <!-- تسجيل الدخول -->
  <div id="login-view" class="card">
    <h2>تسجيل الدخول</h2>
    <form id="loginForm">
      <label>اسم المستخدم</label>
      <input type="text" id="login-username" required autocomplete="username">
      <label>كلمة المرور</label>
      <input type="password" id="login-password" required autocomplete="current-password">
      <button type="submit">دخول</button>
    </form>
    <div class="note">إذا لم يكن هناك مستخدمين، يمكنك إنشاؤهم من الإعدادات بعد الدخول كـ admin/admin</div>
  </div>

  <!-- القائمة الرئيسية -->
  <div id="main-view" class="card" style="display:none">
    <h2>مكتب المحامي إبراهيم الجبهة</h2>
    <div class="menu-list">
      <button class="menu-btn" onclick="goto('add-case')" id="menu-add-case"><i class="fas fa-file-circle-plus"></i>إدخال تفاصيل ملف القضية</button>
      <button class="menu-btn" onclick="goto('search-case')" id="menu-search-case"><i class="fas fa-search"></i>بحث عن القضية</button>
      <button class="menu-btn" onclick="goto('future-sync')" id="menu-sync"><i class="fas fa-cloud"></i>المزامنة والإعدادات</button>
      <button class="menu-btn" onclick="goto('settings')" id="menu-settings"><i class="fas fa-cog"></i>الإعدادات</button>
      <button class="menu-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i>تسجيل الخروج</button>
    </div>
    <div class="note" id="user-welcome"></div>
  </div>
  <!-- إدخال تفاصيل قضية -->
  <div id="add-case-view" class="card" style="display:none">
    <h2>إدخال تفاصيل القضية</h2>
    <div id="sysInfoRow" class="sys-info-row" style="display:none"></div>
    <button type="button" class="excel-btn" onclick="exportToExcel('cases')"><i class="fas fa-file-excel"></i>تصدير إلى Excel</button>
    <button type="button" class="excel-btn" onclick="showActivityHistory()"><i class="fas fa-clock"></i>سجل الدخول/التعديلات</button>
    <button type="button" class="excel-btn" onclick="previewExcelFile()" id="preview-excel-btn"><i class="fas fa-eye"></i>معاينة ملف Excel</button>
    <div id="activityHistoryDialog" style="display:none;">
      <h3 style="color:#fff; background:#145da0; border-radius:7px; padding:7px 0; text-align:center; margin:8px 0;">سجل الدخول والتعديلات</h3>
      <ul id="activityHistoryList"></ul>
      <button onclick="closeActivityHistory()" class="settings-btn" style="margin: 9px auto 0 auto; width:100px;">إغلاق</button>
    </div>
    <form id="addCaseForm" autocomplete="off">
      <div id="addCaseFields"></div>
      <button type="submit">حفظ</button>
      <button type="button" onclick="goto('main')">عودة</button>
    </form>
  </div>
  <!-- بحث عن القضايا -->
  <div id="search-case-view" class="card" style="display:none">
    <h2>بحث عن القضايا</h2>
    <button type="button" class="excel-btn" onclick="exportToExcel('search')"><i class="fas fa-file-excel"></i>تصدير نتائج البحث إلى Excel</button>
    <form id="searchCaseForm">
      <div id="searchCaseFields"></div>
      <button type="submit">بحث</button>
      <button type="button" onclick="goto('main')">عودة</button>
    </form>
    <div class="table-wrap">
      <table id="searchResultsTable" style="display:none;">
        <thead><tr id="searchResultsHeader"></tr></thead>
        <tbody id="searchResultsBody"></tbody>
      </table>
    </div>
  </div>
  <!-- إدارة المستخدمين (من الإعدادات) -->
  <div id="admin-users-view" class="card" style="display:none">
    <h2>إدارة المستخدمين</h2>
    <form id="userForm">
      <label>اسم المستخدم</label>
      <input type="text" id="username" required>
      <label>كلمة المرور</label>
      <input type="password" id="password" required>
      <label>صلاحية المستخدم</label>
      <select id="role" required>
        <option value="admin">مدير نظام (كامل الصلاحيات)</option>
        <option value="lawyer">محامي (صلاحيات محدودة)</option>
      </select>
      <small style="color:#fff;margin-top:6px;display:block;">
        <b>مدير نظام:</b> يملك جميع الصلاحيات.<br>
        <b>محامي:</b> فقط إدخال وتعديل القضايا والبحث عنها.
      </small>
      <button type="submit" id="addUserBtn">إضافة مستخدم</button>
      <button type="button" id="updateUserBtn" style="display:none;">تحديث</button>
      <button type="button" id="cancelUserEditBtn" style="display:none;background:#aaa;">إلغاء</button>
    </form>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>اسم المستخدم</th>
            <th>كلمة المرور</th>
            <th>الصلاحية</th>
            <th>الإجراءات</th>
          </tr>
        </thead>
        <tbody id="usersTableBody"></tbody>
      </table>
    </div>
    <button style="margin-top:18px" onclick="goto('settings')">عودة</button>
  </div>
  <!-- إدارة الحقول (من الإعدادات) -->
  <div id="admin-fields-view" class="card" style="display:none">
    <h2>إدارة حقول القضية</h2>
    <form id="fieldForm">
      <label>اسم الحقل</label>
      <input type="text" id="fieldLabel" required>
      <label>نوع الحقل</label>
      <select id="fieldType" required>
        <option value="">اختر النوع</option>
        <option value="text">نص قصير</option>
        <option value="textarea">نص طويل</option>
        <option value="number">رقم</option>
        <option value="date">تاريخ</option>
        <option value="select">قائمة منسدلة</option>
        <option value="file">ملف</option>
        <option value="tel">رقم هاتف</option>
        <option value="readonly">قراءة فقط</option>
      </select>
      <div id="optionsRow" style="display:none;">
        <label>خيارات القائمة المنسدلة (افصل بينها بعلامة |)</label>
        <input type="text" id="fieldOptions" placeholder="مثال: مدني|جنائي|أحوال شخصية|تنفيذ|أخرى">
        <div class="note">مثال: لعمل قائمة مثل <b>نوع القضية</b> اكتب: مدني|جنائي|أحوال شخصية|تنفيذ|أخرى</div>
      </div>
      <label><input type="checkbox" id="fieldRequired"> إلزامي</label>
      <button type="submit" id="addFieldBtn">إضافة حقل</button>
      <button type="button" id="updateFieldBtn" style="display:none;">تحديث</button>
      <button type="button" id="cancelFieldEditBtn" style="display:none;background:#aaa;">إلغاء</button>
    </form>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>اسم الحقل</th>
            <th>النوع</th>
            <th>إلزامي</th>
            <th>خيارات</th>
            <th>الإجراءات</th>
          </tr>
        </thead>
        <tbody id="fieldsTableBody"></tbody>
      </table>
    </div>
    <button style="margin-top:18px" onclick="goto('settings')">عودة</button>
  </div>
  <!-- الإعدادات -->
  <div id="settings-view" class="card" style="display:none">
    <h2>الإعدادات</h2>
    <div class="settings-section">
      <div class="settings-list">
        <button class="settings-btn" onclick="goto('admin-users')"><i class="fas fa-users"></i>إدارة المستخدمين</button>
        <button class="settings-btn" onclick="goto('admin-fields')"><i class="fas fa-table-cells"></i>إدارة الحقول</button>
        <a class="future-link" href="#" onclick="goto('future-sync');return false;"><i class="fas fa-cloud"></i>الميزات المستقبلية</a>
      </div>
      <button class="settings-btn" style="background: #b1d4e0; color: var(--dark-blue);" onclick="goto('main')"><i class="fas fa-arrow-right"></i>عودة</button>
    </div>
  </div>
  <!-- المزامنة والإعدادات المستقبلية -->
  <div id="future-sync-view" class="card" style="display:none">
    <h2>المزامنة والإعدادات المستقبلية</h2>
    <div class="note" style="font-size:1.01em;">
      <b>المزايا المستقبلية:</b><br>
      <ul style="text-align:right;direction:rtl;">
        <li>المزامنة التلقائية مع Google Drive عند توفر الإنترنت.</li>
        <li>حفظ القضايا وملفاتها في الجهاز ومزامنتها مع نسخة على Google Drive.</li>
        <li>إدارة صلاحيات المستخدمين وربطهم بمزامنة البيانات.</li>
        <li>عرض وإدارة النسخ الاحتياطية واستعادتها.</li>
        <li>ربط تنبيهات الجلسات بالتقويم.</li>
      </ul>
      <button class="settings-btn" style="margin-top:7px" onclick="openGoogleDrive()"><i class="fab fa-google-drive"></i>مزامنة مع Google Drive</button>
      <button class="settings-btn" style="margin-top:7px" onclick="saveCasesLocal()"><i class="fas fa-download"></i>حفظ نسخة من البيانات على الجهاز</button>
      <button class="settings-btn" style="margin-top:7px" onclick="exportToExcel('cases')"><i class="fas fa-file-excel"></i>تصدير جميع القضايا إلى Excel</button>
      <div class="note" style="color:var(--medium-blue);margin-top:7px;">
        يمكنك دمج API Google Drive لاحقًا لمزامنة فعلية (راسل المطور لمزيد من البرمجة).
      </div>
    </div>
    <button style="margin-top:13px" class="settings-btn" onclick="goto('main')"><i class="fas fa-arrow-right"></i>عودة</button>
  </div>
</div>
<script>
// سجل المستخدمين والنشاطات
let users = JSON.parse(localStorage.getItem('users') || '[]');
let fields = JSON.parse(localStorage.getItem('case_fields') || '[]');
let cases = JSON.parse(localStorage.getItem('cases') || '[]');
let userEditIndex = -1, fieldEditIndex = -1, loggedUser = null, loggedRole = null;
let lastSearchResults = [];
let sysActivities = JSON.parse(localStorage.getItem('sys_activities') || '[]');

// التنقل بين الواجهات مع الاحتفاظ بآخر صفحة
function goto(view){
  history.replaceState({appview:view},"");
  document.querySelectorAll('.card').forEach(div=>div.style.display="none");
  document.getElementById(view+'-view').style.display = "block";
  if(view==="main") { 
    document.getElementById("user-welcome").innerText = loggedUser ? "مرحباً، " + loggedUser : "";
    updateMenuByRole();
  }
  if(view==="admin-users") renderUsers();
  if(view==="admin-fields") renderFields();
  if(view==="add-case") { renderAddCaseForm(); renderSysInfo(); }
  if(view==="search-case") renderSearchCaseForm();
}
window.addEventListener('popstate', function(e){
  if(e.state && e.state.appview) goto(e.state.appview);
});

function updateMenuByRole() {
  // صلاحيات المحامي محددة فقط لإضافة/تعديل/بحث القضايا
  let isAdmin = (loggedRole === "admin");
  document.getElementById("menu-settings").classList.toggle("disabled", !isAdmin);
  document.getElementById("menu-sync").classList.toggle("disabled", !isAdmin);
}

// Google Drive
function openGoogleDrive() {
  window.open("https://drive.google.com/drive/my-drive", "_blank");
}

// حفظ نسخة برمجياً (JSON download)
function saveCasesLocal() {
  let headers = fields.map(f=>f.label);
  let rows = cases.map(row => {
    let obj = {};
    headers.forEach(h=> obj[h]=(row[h]!==undefined ? row[h] : ""));
    return obj;
  });
  let blob = new Blob([JSON.stringify(rows,null,2)], {type: "application/json"});
  let link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "cases_"+(new Date().toISOString().slice(0,10))+".json";
  document.body.appendChild(link); link.click();
  document.body.removeChild(link);
}

// تنبيه
function showAlert(txt, timeout=1800) {
  let alertDiv = document.getElementById("alert");
  alertDiv.innerText = txt;
  alertDiv.style.display = "block";
  if(timeout > 0) setTimeout(()=>{alertDiv.style.display="none"}, timeout);
}

// تسجيل الدخول (يوزر افتراضي admin/admin)
document.getElementById("loginForm").onsubmit = function(e){
  e.preventDefault();
  let u = document.getElementById("login-username").value.trim();
  let p = document.getElementById("login-password").value;
  let found = users.find(user=>user.username===u && user.password===p);
  let role = found ? found.role : ((users.length === 0 && u==="admin" && p==="admin") ? "admin" : null);
  if(role){
    loggedUser = u;
    loggedRole = role;
    let now = new Date();
    sysActivities.push({
      username: u,
      dt: now.toLocaleDateString("ar-EG") + " " + now.toLocaleTimeString("ar-EG").replace(/:\d\d /," "),
      action: "لم يقم بتعديل"
    });
    localStorage.setItem('sys_activities', JSON.stringify(sysActivities));
    showAlert("تم تسجيل الدخول بنجاح",1200);
    goto('main');
  } else {
    showAlert("بيانات الدخول غير صحيحة!",2500);
  }
  this.reset();
}
function logout(){ loggedUser=null; loggedRole=null; goto('login'); }

// إدارة المستخدمين
function renderUsers() {
  const tbody = document.getElementById("usersTableBody");
  tbody.innerHTML = "";
  users.forEach((user, i) => {
    const tr = document.createElement("tr");
    if (userEditIndex === i) tr.style.background="#e8f5ff";
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${user.username}</td>
      <td>${user.password}</td>
      <td>${user.role==="admin"?"مدير نظام":"محامي"}</td>
      <td>
        <button onclick="editUser(${i})">تعديل</button>
        <button onclick="deleteUser(${i})" style="background:#d33;">حذف</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}
function saveUsers() { localStorage.setItem('users', JSON.stringify(users)); }
document.getElementById("userForm").onsubmit = function(e) {
  e.preventDefault();
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value;
  const role = document.getElementById("role").value;
  if (!username || !password || !role) return;
  if (users.find((u, idx) => u.username === username && idx !== userEditIndex)) {
    showAlert("اسم المستخدم موجود بالفعل!",3000); return;
  }
  if(userEditIndex === -1) {
    users.push({username, password, role});
    showAlert("تمت إضافة المستخدم بنجاح");
    saveUsers(); renderUsers(); this.reset();
  } else {
    users[userEditIndex] = {username, password, role};
    showAlert("تم تعديل المستخدم بنجاح");
    saveUsers(); renderUsers(); this.reset(); setUserEdit(-1);
  }
};
window.editUser = function(i) {
  userEditIndex = i;
  document.getElementById("username").value = users[i].username;
  document.getElementById("password").value = users[i].password;
  document.getElementById("role").value = users[i].role;
  setUserEdit(i);
};
window.deleteUser = function(i) {
  if(confirm("هل تريد حذف المستخدم؟")) {
    users.splice(i, 1);
    showAlert("تم حذف المستخدم");
    saveUsers(); renderUsers(); setUserEdit(-1); document.getElementById("userForm").reset();
  }
};
document.getElementById("updateUserBtn").onclick = function() {
  document.getElementById("userForm").onsubmit(new Event("submit"));
};
document.getElementById("cancelUserEditBtn").onclick = function() {
  document.getElementById("userForm").reset(); setUserEdit(-1);
};
function setUserEdit(i) {
  userEditIndex = i;
  document.getElementById("addUserBtn").style.display = (i === -1) ? "" : "none";
  document.getElementById("updateUserBtn").style.display = (i !== -1) ? "" : "none";
  document.getElementById("cancelUserEditBtn").style.display = (i !== -1) ? "" : "none";
  renderUsers();
}

// إدارة الحقول
function renderFields() {
  const tbody = document.getElementById("fieldsTableBody");
  tbody.innerHTML = "";
  fields.forEach((field, i) => {
    const tr = document.createElement("tr");
    if (fieldEditIndex === i) tr.style.background="#e8f5ff";
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${field.label}</td>
      <td>${field.type}</td>
      <td>${field.required ? "✔️" : ""}</td>
      <td>${field.type==="select"? (field.options || "").split("|").join(" | ") : ""}</td>
      <td>
        <button onclick="editField(${i})">تعديل</button>
        <button onclick="deleteField(${i})" style="background:#d33;">حذف</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}
function saveFields() { localStorage.setItem('case_fields', JSON.stringify(fields)); }
document.getElementById("fieldType").onchange = function() {
  document.getElementById("optionsRow").style.display = (this.value === "select") ? "" : "none";
};
document.getElementById("fieldForm").onsubmit = function(e) {
  e.preventDefault();
  let label = document.getElementById("fieldLabel").value.trim();
  let type = document.getElementById("fieldType").value;
  let required = document.getElementById("fieldRequired").checked;
  let options = document.getElementById("fieldOptions").value.trim();
  if(!label || !type) return;
  let field = {label, type, required};
  if(type === "select") field.options = options;
  if(fieldEditIndex === -1) {
    fields.push(field); showAlert("تمت إضافة الحقل");
  } else {
    fields[fieldEditIndex] = field; showAlert("تم تعديل الحقل");
  }
  saveFields(); renderFields(); this.reset(); setFieldEdit(-1);
};
window.editField = function(i) {
  fieldEditIndex = i;
  let f = fields[i];
  document.getElementById("fieldLabel").value = f.label;
  document.getElementById("fieldType").value = f.type;
  document.getElementById("fieldRequired").checked = !!f.required;
  document.getElementById("optionsRow").style.display = (f.type === "select") ? "" : "none";
  document.getElementById("fieldOptions").value = f.options || "";
  setFieldEdit(i);
};
window.deleteField = function(i) {
  if(confirm("هل تريد حذف الحقل؟")) {
    fields.splice(i, 1); showAlert("تم حذف الحقل");
    saveFields(); renderFields(); setFieldEdit(-1); document.getElementById("fieldForm").reset();
  }
};
document.getElementById("updateFieldBtn").onclick = function() {
  document.getElementById("fieldForm").onsubmit(new Event("submit"));
};
document.getElementById("cancelFieldEditBtn").onclick = function() {
  document.getElementById("fieldForm").reset(); setFieldEdit(-1);
};
function setFieldEdit(i) {
  fieldEditIndex = i;
  document.getElementById("addFieldBtn").style.display = (i === -1) ? "" : "none";
  document.getElementById("updateFieldBtn").style.display = (i !== -1) ? "" : "none";
  document.getElementById("cancelFieldEditBtn").style.display = (i !== -1) ? "" : "none";
  renderFields();
}

// سجل دخول وتعديلات متعدد
function renderSysInfo() {
  let row = document.getElementById("sysInfoRow");
  let arr = sysActivities || [];
  if(arr.length) {
    let last = arr[arr.length-1];
    row.style.display = "";
    row.innerHTML = `
      <span><i class="fa fa-user"></i> ${last.username}</span>
      <span><i class="fa fa-calendar-alt"></i> ${last.dt}</span>
      <span>${last.action}</span>
    `;
  } else {
    row.style.display = "none";
  }
}
// سجل جميع العمليات - عرض نافذة
function showActivityHistory() {
  let dialog = document.getElementById("activityHistoryDialog");
  let ul = document.getElementById("activityHistoryList");
  let arr = sysActivities || [];
  ul.innerHTML = arr.length ? arr.map(a=>
    `<li><b>${a.username}</b> - <span>${a.dt}</span> - <span>${a.action}</span></li>`
  ).join('') : "<li>لا يوجد سجل دخول/تعديلات بعد</li>";
  dialog.style.display = "block";
}
function closeActivityHistory() {
  document.getElementById("activityHistoryDialog").style.display = "none";
}

// إدخال تفاصيل قضية مع ملء تلقائي عند تكرار الرقم
function renderAddCaseForm(){
  let cont = document.getElementById("addCaseFields");
  cont.innerHTML = "";
  fields.forEach((f,i)=>{
    let html = "";
    html += `<label>${f.label}${f.required?' *':''}</label>`;
    // تمييز أول حقل رقم قضية (أو أي حقل اسمه يحتوي على "رقم" و"قضية")
    let isCaseNumber = /رقم.*قضية/.test(f.label);
    if(f.type === 'number'){
      html += `<input type="text" inputmode="decimal" pattern="[0-9\\-\\,\\.\\/\\s]*" name="field_${i}" ${f.required?'required':''} ${isCaseNumber?'onchange="autoFillCaseFields(this.value)"':''}>`;
    } else if(f.type === 'text')
      html += `<input type="text" name="field_${i}" ${f.required?'required':''} ${isCaseNumber?'onchange="autoFillCaseFields(this.value)"':''}>`;
    else if(f.type === 'textarea')
      html += `<textarea name="field_${i}" ${f.required?'required':''}></textarea>`;
    else if(f.type === 'tel')
      html += `<input type="tel" name="field_${i}" ${f.required?'required':''}>`;
    else if(f.type === 'date')
      html += `<input type="date" name="field_${i}" ${f.required?'required':''}>`;
    else if(f.type === 'file')
      html += `<input type="file" name="field_${i}" ${f.required?'required':''}>`;
    else if(f.type === 'readonly')
      html += `<input type="text" name="field_${i}" readonly value="${loggedUser || ''}">`;
    else if(f.type === 'select'){
      html += `<select name="field_${i}" ${f.required?'required':''}>`;
      let opts = (f.options||"").split("|");
      opts.forEach(opt => html += `<option value="${opt.trim()}">${opt.trim()}</option>`);
      html += `</select>`;
    }
    let div = document.createElement("div"); div.innerHTML = html; cont.appendChild(div);
  });
  renderSysInfo();
}
window.autoFillCaseFields = function(val) {
  let input = event.target;
  let value = val.trim();
  if(!value) return;
  // البحث عن نفس رقم القضية في القضايا المحفوظة
  let idx = -1, fieldIdx = -1;
  // ابحث عن أول حقل رقم قضية في الحقول
  fields.forEach((f,i)=>{ if(/رقم.*قضية/.test(f.label)) fieldIdx = i; });
  for(let j=0; j<cases.length; j++) {
    let rec = cases[j];
    let fieldName = fields[fieldIdx] && fields[fieldIdx].label;
    if(rec[fieldName] && rec[fieldName] === value) { idx = j; break; }
  }
  if(idx >= 0) {
    // تعبئة باقي الحقول لنفس رقم القضية
    fields.forEach((f,i)=>{
      if(i===fieldIdx) return;
      let formField = document.forms["addCaseForm"]["field_"+i];
      if(formField) {
        formField.value = cases[idx][f.label] || "";
      }
    });
    showAlert("تم ملء الحقول تلقائياً لرقم القضية المدخلة");
  }
};

// تحميل ملف إكسل محفوظ ومعاينته (preview)
function previewExcelFile() {
  let input = document.createElement('input');
  input.type = 'file';
  input.accept = '.csv,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,text/csv';
  input.onchange = function(e){
    let file = e.target.files[0];
    if(!file) return;
    let reader = new FileReader();
    reader.onload = function(evt) {
      let data = evt.target.result;
      showExcelPreview(data);
    };
    reader.readAsText(file);
  };
  input.click();
}
function showExcelPreview(data) {
  let rows = data.split(/\r?\n/).filter(Boolean);
  let html = `<div style="max-height:320px;overflow:auto;background:#fff;border-radius:8px;padding:8px;direction:ltr;color:#222;font-size:0.95em;">
      <table border="1" style="border-collapse:collapse;width:100%;">
      ${rows.map(r=>`<tr>${r.split(',').map(cell=>`<td>${cell.replace(/^"|"$/g,'')}</td>`).join('')}</tr>`).join('')}
      </table>
      <button onclick="this.parentNode.remove()" style="margin-top:7px;" class="settings-btn">إغلاق</button>
      </div>`;
  let div = document.createElement("div");
  div.style = "position:fixed;top:0;left:0;width:100vw;height:100vh;background:#0008;z-index:9999;display:flex;align-items:center;justify-content:center;";
  div.innerHTML = html;
  document.body.appendChild(div);
}

// تصدير إكسل (يدعم تصدير القضايا أو نتائج البحث)
function exportToExcel(from){
  let data = (from === 'search') ? lastSearchResults : cases;
  if(fields.length === 0 || data.length === 0) { showAlert('لا توجد بيانات للتصدير!'); return; }
  let headers = fields.map(f=>f.label);
  let rows = data.map(row => headers.map(h=> row[h]!==undefined ? row[h] : ""));
  let csv = "\uFEFF" + headers.join(",") + "\n";
  rows.forEach(r=>{ csv += r.map(v=>`"${(v+'').replace(/"/g,'""')}"`).join(",") + "\n"; });
  let blob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
  let link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = (from==='search'?'search_results':'cases')+"_"+(new Date().toISOString().slice(0,10))+".csv";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// بحث عن القضايا
function renderSearchCaseForm(){
  let cont = document.getElementById("searchCaseFields");
  cont.innerHTML = "";
  fields.forEach((f,i)=>{
    let html = `<label>${f.label}</label>`;
    if(f.type === 'number')
      html += `<input type="text" inputmode="decimal" pattern="[0-9\\-\\,\\.\\/\\s]*" name="field_${i}">`;
    else if(f.type === 'text' || f.type === 'tel' || f.type === 'date')
      html += `<input type="${f.type}" name="field_${i}">`;
    else if(f.type === 'select'){
      html += `<select name="field_${i}"><option value="">الكل</option>`;
      (f.options||"").split("|").forEach(opt=>html+=`<option value="${opt.trim()}">${opt.trim()}</option>`);
      html += `</select>`;
    } else if(f.type === "readonly"){
      html += `<input type="text" name="field_${i}" readonly value="">`;
    } else if(f.type === "textarea"){
      html += `<input type="text" name="field_${i}">`;
    }
    let div = document.createElement("div"); div.innerHTML = html; cont.appendChild(div);
  });
  document.getElementById("searchResultsTable").style.display = "none";
}
document.getElementById("searchCaseForm").onsubmit = function(e){
  e.preventDefault();
  let q = {};
  fields.forEach((f,i)=>{
    let v = this["field_"+i];
    if(v && v.value) q[f.label] = v.value.trim();
  });
  let results = cases.filter(row=>{
    let ok = true;
    for(let k in q){
      if(!row[k] || !(""+row[k]).includes(q[k])) ok = false;
    }
    return ok;
  });
  lastSearchResults = results;
  renderSearchResults(results);
}
function renderSearchResults(results){
  let table = document.getElementById("searchResultsTable");
  let thead = document.getElementById("searchResultsHeader");
  let tbody = document.getElementById("searchResultsBody");
  if(results.length == 0){
    table.style.display = "none";
    showAlert("لا توجد نتائج مطابقة",2200);
    return;
  }
  table.style.display = "table";
  thead.innerHTML = ""; tbody.innerHTML = "";
  let headers = fields.slice(0,3).map(f=>`<th>${f.label}</th>`).join("") + `<th>إجراءات</th>`;
  thead.innerHTML = headers;
  results.forEach((row,idx)=>{
    let tr = document.createElement("tr");
    tr.innerHTML = `
      ${fields.slice(0,3).map(f=>`<td>${row[f.label]||""}</td>`).join("")}
      <td><button onclick="previewCase(${idx})">معاينة</button></td>
    `;
    tbody.appendChild(tr);
  });
}

// معاينة قضية (نافذة منبثقة)
function previewCase(idx){
  let c = lastSearchResults[idx];
  let cont = document.createElement("div");
  cont.style="background:var(--white);border:2px solid var(--light-blue);padding:18px 7px;max-width:340px;margin:60px auto;border-radius:15px;box-shadow:0 4px 24px var(--shadow);position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:1000;";
  cont.innerHTML = `<h3 style="color:var(--dark-blue);border-bottom:1.5px solid var(--light-blue);padding-bottom:7px;margin-top:0;">معاينة القضية</h3>`;
  fields.forEach(f => {
    cont.innerHTML += `<div style="margin:7px 0;"><b style="color:var(--light-blue);">${f.label}:</b> <span style="color:var(--dark-blue);">${c[f.label]||""}</span></div>`;
  });
  cont.innerHTML += `<button onclick="this.parentNode.remove()" class="settings-btn" style="margin-top:7px;">إغلاق</button>`;
  document.body.appendChild(cont);
}

// بداية النظام - استرجاع آخر واجهة
(function init(){
  let lastView = (history.state && history.state.appview) || "login";
  goto(lastView);
})();
</script>
</body>
</html>